<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memoria del Proyecto - Sistema de Control de Fichajes de Empleados</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            background: white;
            font-size: 11pt;
        }
        
        @media print {
            body {
                padding: 15mm;
            }
            .page-break {
                page-break-before: always;
            }
            h1, h2, h3 {
                page-break-after: avoid;
            }
        }
        
        .cover-page {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            page-break-after: always;
        }
        
        .cover-page h1 {
            font-size: 28pt;
            color: #1e40af;
            margin-bottom: 20px;
            line-height: 1.3;
        }
        
        .cover-page .subtitle {
            font-size: 16pt;
            color: #64748b;
            margin-bottom: 40px;
        }
        
        .cover-page .info {
            margin-top: 60px;
            font-size: 12pt;
            color: #475569;
        }
        
        .cover-page .date {
            margin-top: 20px;
            font-size: 11pt;
            color: #94a3b8;
        }
        
        .toc {
            page-break-after: always;
        }
        
        .toc h2 {
            color: #1e40af;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .toc ul {
            list-style: none;
        }
        
        .toc li {
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }
        
        .toc a {
            color: #333;
            text-decoration: none;
        }
        
        .toc .level-1 { font-weight: 600; margin-top: 15px; }
        .toc .level-2 { padding-left: 20px; }
        .toc .level-3 { padding-left: 40px; font-size: 10pt; }
        
        h1 {
            font-size: 22pt;
            color: #1e40af;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #1e40af;
        }
        
        h2 {
            font-size: 16pt;
            color: #1e3a8a;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #3b82f6;
        }
        
        h3 {
            font-size: 13pt;
            color: #1d4ed8;
            margin: 20px 0 10px 0;
        }
        
        h4 {
            font-size: 11pt;
            color: #2563eb;
            margin: 15px 0 8px 0;
        }
        
        p {
            margin-bottom: 12px;
            text-align: justify;
        }
        
        ul, ol {
            margin: 10px 0 15px 25px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10pt;
        }
        
        th, td {
            border: 1px solid #cbd5e1;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #1e40af;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        code {
            background-color: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 10pt;
        }
        
        pre {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 9pt;
            line-height: 1.5;
        }
        
        .highlight {
            background-color: #fef3c7;
            padding: 15px;
            border-left: 4px solid #f59e0b;
            margin: 15px 0;
        }
        
        .info-box {
            background-color: #eff6ff;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            margin: 15px 0;
        }
        
        .diagram {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            border-radius: 8px;
        }
        
        .diagram-box {
            display: inline-block;
            background: #1e40af;
            color: white;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .diagram-arrow {
            display: inline-block;
            font-size: 20pt;
            color: #64748b;
            margin: 0 10px;
        }
        
        figure {
            margin: 20px 0;
            text-align: center;
        }
        
        figcaption {
            font-size: 10pt;
            color: #64748b;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>
<body>

<!-- PORTADA -->
<div class="cover-page">
    <h1>SISTEMA DE CONTROL DE FICHAJES DE EMPLEADOS</h1>
    <p class="subtitle">Aplicación Web y Móvil para la Gestión del Tiempo de Trabajo</p>
    <div class="info">
        <p><strong>Proyecto de Desarrollo de Aplicaciones</strong></p>
        <p>Full-Stack Web & Mobile Development</p>
    </div>
    <div class="date">
        <p>Noviembre 2025</p>
    </div>
</div>

<!-- ÍNDICE -->
<div class="toc page-break">
    <h2>TABLA DE CONTENIDO</h2>
    <ul>
        <li class="level-1"><a href="#intro">1. INTRODUCCIÓN</a></li>
        <li class="level-2"><a href="#desc">1.1. Descripción del Proyecto</a></li>
        <li class="level-2"><a href="#info">1.2. Información General</a></li>
        <li class="level-2"><a href="#obj">1.3. Objetivos del Proyecto</a></li>
        
        <li class="level-1"><a href="#contexto">2. CONTEXTUALIZACIÓN DEL PROYECTO</a></li>
        <li class="level-2"><a href="#obj-concretos">2.1. Objetivos Concretos</a></li>
        <li class="level-2"><a href="#tech">2.2. Tecnologías Utilizadas</a></li>
        <li class="level-2"><a href="#tech-alt">2.3. Tecnologías Alternativas</a></li>
        
        <li class="level-1"><a href="#planif">3. PLANIFICACIÓN DEL PROYECTO</a></li>
        <li class="level-2"><a href="#temp">3.1. Temporalización</a></li>
        <li class="level-2"><a href="#metod">3.2. Metodología de Desarrollo</a></li>
        
        <li class="level-1"><a href="#desarrollo">4. DESARROLLO DEL PROYECTO</a></li>
        <li class="level-2"><a href="#fase0">4.0. Fase 0: Fase Previa</a></li>
        <li class="level-2"><a href="#fase1">4.1. Fase 1: Fase de Concepción</a></li>
        <li class="level-2"><a href="#fase2">4.2. Fase 2: Fase de Diseño</a></li>
        <li class="level-2"><a href="#fase3">4.3. Fase 3: Fase de Planificación</a></li>
        <li class="level-2"><a href="#fase4">4.4. Fase 4: Fase de Producción</a></li>
        <li class="level-2"><a href="#fase5">4.5. Fase 5: Fase de Pruebas</a></li>
        <li class="level-2"><a href="#fase6">4.6. Fase 6: Fase de Despliegue</a></li>
        
        <li class="level-1"><a href="#arquitectura">5. ARQUITECTURA DE LA APLICACIÓN</a></li>
        <li class="level-2"><a href="#arq-general">5.1. Arquitectura General</a></li>
        <li class="level-2"><a href="#arq-backend">5.2. Arquitectura del Backend</a></li>
        <li class="level-2"><a href="#arq-frontend">5.3. Arquitectura del Frontend</a></li>
        
        <li class="level-1"><a href="#visual">6. ESTRUCTURA VISUAL DE LA APLICACIÓN</a></li>
        <li class="level-2"><a href="#visual-web">6.1. Aplicación Web</a></li>
        <li class="level-2"><a href="#visual-mobile">6.2. Aplicación Móvil</a></li>
        
        <li class="level-1"><a href="#datos">7. GESTIÓN DE DATOS</a></li>
        <li class="level-2"><a href="#modelo">7.1. Modelo de Datos</a></li>
        <li class="level-2"><a href="#timezone">7.2. Gestión de Zonas Horarias</a></li>
        
        <li class="level-1"><a href="#seguridad">8. SEGURIDAD</a></li>
        <li class="level-2"><a href="#auth">8.1. Autenticación</a></li>
        <li class="level-2"><a href="#authz">8.2. Autorización</a></li>
        
        <li class="level-1"><a href="#tests">9. TESTS Y VALIDACIÓN</a></li>
        
        <li class="level-1"><a href="#analisis">10. ANÁLISIS Y VALORACIÓN</a></li>
        <li class="level-2"><a href="#conclusiones">10.1. Conclusiones</a></li>
        <li class="level-2"><a href="#mejoras">10.2. Mejoras Propuestas</a></li>
        
        <li class="level-1"><a href="#biblio">11. BIBLIOGRAFÍA Y REFERENCIAS</a></li>
        
        <li class="level-1"><a href="#anexos">12. ANEXOS</a></li>
    </ul>
</div>

<!-- CAPÍTULO 1: INTRODUCCIÓN -->
<h1 id="intro" class="page-break">1. INTRODUCCIÓN</h1>

<h2 id="desc">1.1. Descripción del Proyecto</h2>

<p>El presente proyecto consiste en el desarrollo de un <strong>Sistema de Control de Fichajes de Empleados</strong>, una solución integral que permite a las organizaciones gestionar de manera eficiente el registro de horas de trabajo de sus empleados. El sistema está compuesto por dos aplicaciones complementarias: una aplicación web para la administración y gestión, y una aplicación móvil para que los empleados puedan fichar desde cualquier ubicación.</p>

<p>La aplicación web proporciona a los administradores y responsables de recursos humanos una plataforma completa para gestionar empleados, departamentos, horarios, incidencias y generar informes detallados. Por su parte, la aplicación móvil ofrece a los empleados una interfaz intuitiva para registrar sus entradas, salidas y pausas, con soporte para geolocalización.</p>

<p>El sistema ha sido diseñado siguiendo los principios de arquitectura moderna, utilizando tecnologías de última generación como React, TypeScript, Node.js y PostgreSQL. Se ha puesto especial énfasis en la experiencia de usuario, la seguridad de los datos y la escalabilidad del sistema.</p>

<div class="info-box">
    <strong>Características principales del sistema:</strong>
    <ul>
        <li>Registro de fichajes con geolocalización opcional</li>
        <li>Gestión completa de empleados, departamentos y roles</li>
        <li>Planificación de horarios con calendario anual</li>
        <li>Control de pausas y descansos</li>
        <li>Gestión de incidencias laborales</li>
        <li>Generación de informes en formato Excel</li>
        <li>Interfaz responsive y modo oscuro</li>
        <li>Aplicación móvil nativa para iOS y Android</li>
    </ul>
</div>

<h2 id="info">1.2. Información General</h2>

<p>El proyecto se ha desarrollado en el entorno de Replit, una plataforma de desarrollo en la nube que permite la creación, ejecución y despliegue de aplicaciones de manera integrada. Esta elección tecnológica ha permitido un desarrollo ágil y la posibilidad de desplegar la aplicación directamente desde la misma plataforma.</p>

<table>
    <tr>
        <th>Aspecto</th>
        <th>Descripción</th>
    </tr>
    <tr>
        <td>Tipo de proyecto</td>
        <td>Aplicación Full-Stack (Web + Móvil)</td>
    </tr>
    <tr>
        <td>Plataforma de desarrollo</td>
        <td>Replit</td>
    </tr>
    <tr>
        <td>Lenguaje principal</td>
        <td>TypeScript</td>
    </tr>
    <tr>
        <td>Base de datos</td>
        <td>PostgreSQL (Neon Serverless)</td>
    </tr>
    <tr>
        <td>Frontend Web</td>
        <td>React 18 + Vite</td>
    </tr>
    <tr>
        <td>Frontend Móvil</td>
        <td>React Native + Expo</td>
    </tr>
    <tr>
        <td>Backend</td>
        <td>Node.js + Express</td>
    </tr>
    <tr>
        <td>ORM</td>
        <td>Drizzle ORM</td>
    </tr>
</table>

<h2 id="obj">1.3. Objetivos del Proyecto</h2>

<p>El objetivo principal del proyecto es desarrollar una solución completa y profesional para la gestión del tiempo de trabajo en organizaciones de cualquier tamaño. Los objetivos específicos incluyen:</p>

<ol>
    <li><strong>Digitalizar el proceso de fichaje:</strong> Eliminar los sistemas manuales de registro de asistencia, reduciendo errores y fraudes.</li>
    <li><strong>Proporcionar visibilidad en tiempo real:</strong> Permitir a los administradores conocer el estado actual de la plantilla en cualquier momento.</li>
    <li><strong>Facilitar la movilidad:</strong> Ofrecer a los empleados la posibilidad de fichar desde cualquier ubicación mediante la aplicación móvil.</li>
    <li><strong>Automatizar la generación de informes:</strong> Crear herramientas que permitan exportar datos de fichajes y horarios para su análisis.</li>
    <li><strong>Garantizar la seguridad:</strong> Implementar mecanismos robustos de autenticación y autorización para proteger los datos sensibles.</li>
    <li><strong>Cumplir con la normativa laboral:</strong> Proporcionar las herramientas necesarias para el cumplimiento de la legislación vigente en materia de registro horario.</li>
</ol>

<!-- CAPÍTULO 2: CONTEXTUALIZACIÓN -->
<h1 id="contexto" class="page-break">2. CONTEXTUALIZACIÓN DEL PROYECTO</h1>

<h2 id="obj-concretos">2.1. Objetivos Concretos</h2>

<p>Para alcanzar los objetivos generales del proyecto, se definieron una serie de objetivos concretos que sirvieron como guía durante todo el proceso de desarrollo:</p>

<h3>2.1.1. Objetivos Funcionales</h3>

<table>
    <tr>
        <th>ID</th>
        <th>Objetivo</th>
        <th>Prioridad</th>
    </tr>
    <tr>
        <td>OF-01</td>
        <td>Implementar sistema de autenticación seguro con roles diferenciados (admin/empleado)</td>
        <td>Alta</td>
    </tr>
    <tr>
        <td>OF-02</td>
        <td>Desarrollar funcionalidad de fichaje (entrada, salida, pausas) con registro temporal preciso</td>
        <td>Alta</td>
    </tr>
    <tr>
        <td>OF-03</td>
        <td>Crear módulo de gestión de empleados con CRUD completo</td>
        <td>Alta</td>
    </tr>
    <tr>
        <td>OF-04</td>
        <td>Implementar gestión de departamentos y roles empresariales</td>
        <td>Media</td>
    </tr>
    <tr>
        <td>OF-05</td>
        <td>Desarrollar sistema de planificación de horarios con calendario anual</td>
        <td>Alta</td>
    </tr>
    <tr>
        <td>OF-06</td>
        <td>Crear módulo de incidencias para registro de ausencias y eventos</td>
        <td>Media</td>
    </tr>
    <tr>
        <td>OF-07</td>
        <td>Implementar geolocalización en fichajes móviles</td>
        <td>Media</td>
    </tr>
    <tr>
        <td>OF-08</td>
        <td>Desarrollar generación de informes en formato Excel</td>
        <td>Alta</td>
    </tr>
    <tr>
        <td>OF-09</td>
        <td>Crear dashboard con estadísticas en tiempo real</td>
        <td>Media</td>
    </tr>
    <tr>
        <td>OF-10</td>
        <td>Implementar visualización de ubicaciones en mapa</td>
        <td>Baja</td>
    </tr>
</table>

<h3>2.1.2. Objetivos Técnicos</h3>

<ul>
    <li><strong>OT-01:</strong> Utilizar TypeScript en todo el proyecto para garantizar tipado estático y reducir errores</li>
    <li><strong>OT-02:</strong> Implementar arquitectura modular que facilite el mantenimiento y escalabilidad</li>
    <li><strong>OT-03:</strong> Gestionar todas las fechas y horas en UTC, mostrándolas en zona horaria española (Europe/Madrid)</li>
    <li><strong>OT-04:</strong> Diseñar API RESTful siguiendo las mejores prácticas</li>
    <li><strong>OT-05:</strong> Implementar validación de datos tanto en frontend como en backend</li>
    <li><strong>OT-06:</strong> Crear interfaces responsivas que funcionen en cualquier dispositivo</li>
    <li><strong>OT-07:</strong> Optimizar consultas de base de datos para garantizar rendimiento</li>
</ul>

<h2 id="tech">2.2. Tecnologías Utilizadas</h2>

<h3>2.2.1. Frontend Web (React + TypeScript)</h3>

<p>Para el desarrollo del frontend web se ha utilizado React 18, la biblioteca de JavaScript más popular para la construcción de interfaces de usuario. La elección de React se fundamenta en su modelo de componentes reutilizables, su amplio ecosistema y su excelente rendimiento gracias al Virtual DOM.</p>

<table>
    <tr>
        <th>Tecnología</th>
        <th>Versión</th>
        <th>Propósito</th>
    </tr>
    <tr>
        <td>React</td>
        <td>18.x</td>
        <td>Biblioteca principal para UI</td>
    </tr>
    <tr>
        <td>TypeScript</td>
        <td>5.x</td>
        <td>Tipado estático</td>
    </tr>
    <tr>
        <td>Vite</td>
        <td>5.x</td>
        <td>Build tool y dev server</td>
    </tr>
    <tr>
        <td>TanStack Query</td>
        <td>5.x</td>
        <td>Gestión de estado del servidor</td>
    </tr>
    <tr>
        <td>Wouter</td>
        <td>3.x</td>
        <td>Enrutamiento</td>
    </tr>
    <tr>
        <td>React Hook Form</td>
        <td>7.x</td>
        <td>Gestión de formularios</td>
    </tr>
    <tr>
        <td>Zod</td>
        <td>3.x</td>
        <td>Validación de esquemas</td>
    </tr>
    <tr>
        <td>Tailwind CSS</td>
        <td>3.x</td>
        <td>Framework de estilos</td>
    </tr>
    <tr>
        <td>Shadcn/UI</td>
        <td>-</td>
        <td>Componentes de interfaz</td>
    </tr>
    <tr>
        <td>Radix UI</td>
        <td>-</td>
        <td>Primitivos accesibles</td>
    </tr>
    <tr>
        <td>Lucide React</td>
        <td>-</td>
        <td>Iconografía</td>
    </tr>
    <tr>
        <td>Recharts</td>
        <td>2.x</td>
        <td>Gráficos y visualizaciones</td>
    </tr>
    <tr>
        <td>React Leaflet</td>
        <td>4.x</td>
        <td>Mapas interactivos</td>
    </tr>
    <tr>
        <td>date-fns</td>
        <td>3.x</td>
        <td>Manipulación de fechas</td>
    </tr>
    <tr>
        <td>ExcelJS</td>
        <td>4.x</td>
        <td>Generación de Excel</td>
    </tr>
</table>

<h3>2.2.2. Frontend Móvil (Expo + React Native)</h3>

<p>La aplicación móvil se ha desarrollado utilizando React Native con Expo, lo que permite crear aplicaciones nativas para iOS y Android desde una única base de código en TypeScript. Expo simplifica significativamente el proceso de desarrollo y distribución de aplicaciones móviles.</p>

<table>
    <tr>
        <th>Tecnología</th>
        <th>Propósito</th>
    </tr>
    <tr>
        <td>Expo SDK 52</td>
        <td>Framework de desarrollo móvil</td>
    </tr>
    <tr>
        <td>React Native</td>
        <td>Framework de UI nativo</td>
    </tr>
    <tr>
        <td>Expo Router</td>
        <td>Navegación basada en archivos</td>
    </tr>
    <tr>
        <td>Expo Location</td>
        <td>Servicios de geolocalización</td>
    </tr>
    <tr>
        <td>Async Storage</td>
        <td>Almacenamiento local persistente</td>
    </tr>
    <tr>
        <td>Expo Secure Store</td>
        <td>Almacenamiento seguro de tokens</td>
    </tr>
    <tr>
        <td>React Native Paper</td>
        <td>Componentes Material Design</td>
    </tr>
</table>

<h3>2.2.3. Backend (Node.js + Express)</h3>

<p>El backend se ha construido sobre Node.js con Express, proporcionando una API RESTful robusta y eficiente. La elección de Node.js permite compartir código y tipos con el frontend, maximizando la coherencia del proyecto.</p>

<table>
    <tr>
        <th>Tecnología</th>
        <th>Propósito</th>
    </tr>
    <tr>
        <td>Node.js 20.x</td>
        <td>Runtime de JavaScript</td>
    </tr>
    <tr>
        <td>Express 4.x</td>
        <td>Framework web</td>
    </tr>
    <tr>
        <td>TypeScript</td>
        <td>Tipado estático</td>
    </tr>
    <tr>
        <td>Drizzle ORM</td>
        <td>Object-Relational Mapping</td>
    </tr>
    <tr>
        <td>express-session</td>
        <td>Gestión de sesiones web</td>
    </tr>
    <tr>
        <td>jsonwebtoken</td>
        <td>Autenticación JWT para móvil</td>
    </tr>
    <tr>
        <td>bcryptjs</td>
        <td>Hash de contraseñas</td>
    </tr>
    <tr>
        <td>Zod</td>
        <td>Validación de datos de entrada</td>
    </tr>
    <tr>
        <td>cors</td>
        <td>Cross-Origin Resource Sharing</td>
    </tr>
</table>

<h3>2.2.4. Base de Datos (PostgreSQL + Drizzle ORM)</h3>

<p>Se ha utilizado PostgreSQL como sistema de gestión de base de datos relacional, alojado en Neon (servicio serverless de PostgreSQL). Drizzle ORM proporciona una capa de abstracción type-safe que garantiza la integridad de los datos.</p>

<div class="highlight">
    <strong>Ventajas de Drizzle ORM:</strong>
    <ul>
        <li>Tipado completo end-to-end con TypeScript</li>
        <li>Generación automática de esquemas Zod para validación</li>
        <li>Migraciones declarativas</li>
        <li>Queries SQL eficientes sin overhead</li>
        <li>Soporte nativo para PostgreSQL, MySQL y SQLite</li>
    </ul>
</div>

<h2 id="tech-alt">2.3. Tecnologías Alternativas Evaluadas</h2>

<p>Durante la fase de diseño del proyecto se evaluaron diversas alternativas tecnológicas. A continuación se presentan las principales opciones consideradas y las razones por las que se optó por la solución final:</p>

<table>
    <tr>
        <th>Categoría</th>
        <th>Alternativas</th>
        <th>Elección Final</th>
        <th>Justificación</th>
    </tr>
    <tr>
        <td>Frontend Framework</td>
        <td>Vue.js, Angular, Svelte</td>
        <td>React</td>
        <td>Mayor ecosistema, mejor integración con React Native, amplia comunidad</td>
    </tr>
    <tr>
        <td>Mobile Framework</td>
        <td>Flutter, Ionic, NativeScript</td>
        <td>React Native + Expo</td>
        <td>Código compartido con web, rendimiento nativo, facilidad de desarrollo</td>
    </tr>
    <tr>
        <td>Backend Framework</td>
        <td>NestJS, Fastify, Hono</td>
        <td>Express</td>
        <td>Simplicidad, madurez, amplia documentación</td>
    </tr>
    <tr>
        <td>ORM</td>
        <td>Prisma, TypeORM, Sequelize</td>
        <td>Drizzle</td>
        <td>Mejor rendimiento, tipado más estricto, menor overhead</td>
    </tr>
    <tr>
        <td>Base de Datos</td>
        <td>MySQL, MongoDB, SQLite</td>
        <td>PostgreSQL</td>
        <td>Robustez, características avanzadas, integración con Replit</td>
    </tr>
    <tr>
        <td>Estilos CSS</td>
        <td>Styled Components, CSS Modules, Sass</td>
        <td>Tailwind CSS</td>
        <td>Desarrollo rápido, consistencia, bundle pequeño</td>
    </tr>
    <tr>
        <td>Estado del Servidor</td>
        <td>Redux, Zustand, SWR</td>
        <td>TanStack Query</td>
        <td>Gestión automática de caché, revalidación, menor boilerplate</td>
    </tr>
</table>

<!-- CAPÍTULO 3: PLANIFICACIÓN -->
<h1 id="planif" class="page-break">3. PLANIFICACIÓN DEL PROYECTO</h1>

<h2 id="temp">3.1. Temporalización</h2>

<p>El proyecto se ha desarrollado siguiendo un enfoque iterativo e incremental, dividido en varias fases que permitieron ir construyendo la aplicación de forma progresiva, validando cada funcionalidad antes de pasar a la siguiente.</p>

<h3>3.1.1. Cronograma General</h3>

<table>
    <tr>
        <th>Fase</th>
        <th>Duración Estimada</th>
        <th>Actividades Principales</th>
    </tr>
    <tr>
        <td>Fase 0: Preparación</td>
        <td>1 semana</td>
        <td>Configuración del entorno, estructura del proyecto, base de datos</td>
    </tr>
    <tr>
        <td>Fase 1: Concepción</td>
        <td>1 semana</td>
        <td>Análisis de requisitos, definición de funcionalidades</td>
    </tr>
    <tr>
        <td>Fase 2: Diseño</td>
        <td>2 semanas</td>
        <td>Diseño de BD, API, interfaces de usuario</td>
    </tr>
    <tr>
        <td>Fase 3: Planificación</td>
        <td>1 semana</td>
        <td>División en módulos, priorización de tareas</td>
    </tr>
    <tr>
        <td>Fase 4: Producción</td>
        <td>6 semanas</td>
        <td>Desarrollo de backend, frontend web y móvil</td>
    </tr>
    <tr>
        <td>Fase 5: Pruebas</td>
        <td>2 semanas</td>
        <td>Testing funcional, integración, corrección de bugs</td>
    </tr>
    <tr>
        <td>Fase 6: Despliegue</td>
        <td>1 semana</td>
        <td>Publicación web, compilación APK</td>
    </tr>
</table>

<h3>3.1.2. Diagrama de Gantt Simplificado</h3>

<div class="diagram">
    <pre style="background: white; color: #333; text-align: left; font-size: 9pt;">
Semana:        1    2    3    4    5    6    7    8    9   10   11   12   13   14
               |    |    |    |    |    |    |    |    |    |    |    |    |    |
Fase 0:        ████
Fase 1:             ████
Fase 2:                  ████████
Fase 3:                            ████
Fase 4:                                 ████████████████████████████
Fase 5:                                                              ████████
Fase 6:                                                                       ████
    </pre>
</div>

<h2 id="metod">3.2. Metodología de Desarrollo</h2>

<p>Se ha seguido una metodología ágil adaptada, combinando elementos de Scrum y desarrollo iterativo. Las características principales de la metodología empleada son:</p>

<h3>3.2.1. Principios Aplicados</h3>

<ul>
    <li><strong>Desarrollo Iterativo:</strong> El proyecto se dividió en iteraciones cortas (sprints de 1-2 semanas), cada una con objetivos claros y entregables definidos.</li>
    <li><strong>Priorización de Funcionalidades:</strong> Se utilizó el método MoSCoW (Must have, Should have, Could have, Won't have) para priorizar las características a desarrollar.</li>
    <li><strong>Feedback Continuo:</strong> Se realizaron revisiones frecuentes del progreso, ajustando el plan según las necesidades emergentes.</li>
    <li><strong>Entrega Incremental:</strong> Cada iteración producía una versión funcional del sistema con nuevas características.</li>
    <li><strong>Documentación Continua:</strong> La documentación se fue generando a lo largo del desarrollo, no al final.</li>
</ul>

<h3>3.2.2. Herramientas de Gestión</h3>

<table>
    <tr>
        <th>Herramienta</th>
        <th>Uso</th>
    </tr>
    <tr>
        <td>Replit</td>
        <td>Entorno de desarrollo integrado, control de versiones, despliegue</td>
    </tr>
    <tr>
        <td>Git</td>
        <td>Control de versiones y gestión del código fuente</td>
    </tr>
    <tr>
        <td>Lista de Tareas Integrada</td>
        <td>Seguimiento de tareas y progreso</td>
    </tr>
    <tr>
        <td>Checkpoints Automáticos</td>
        <td>Puntos de restauración del proyecto</td>
    </tr>
</table>

<!-- CAPÍTULO 4: DESARROLLO -->
<h1 id="desarrollo" class="page-break">4. DESARROLLO DEL PROYECTO</h1>

<h2 id="fase0">4.0. Fase 0: Fase Previa</h2>

<h3>4.0.1. Configuración del Entorno</h3>

<h4>4.0.1.1. Replit como Plataforma de Desarrollo</h4>

<p>Replit es una plataforma de desarrollo en la nube que proporciona un entorno de desarrollo integrado (IDE) accesible desde cualquier navegador. Para este proyecto, Replit ofreció las siguientes ventajas:</p>

<ul>
    <li><strong>Entorno preconfigurado:</strong> Node.js, npm y las herramientas necesarias ya están instaladas</li>
    <li><strong>Base de datos integrada:</strong> PostgreSQL disponible con un solo clic</li>
    <li><strong>Despliegue automático:</strong> Publicación de la aplicación sin configuración adicional</li>
    <li><strong>Colaboración en tiempo real:</strong> Posibilidad de trabajar en equipo simultáneamente</li>
    <li><strong>Gestión de secretos:</strong> Almacenamiento seguro de variables de entorno</li>
</ul>

<h4>4.0.1.2. Configuración de Base de Datos PostgreSQL</h4>

<p>La base de datos PostgreSQL se configuró utilizando el servicio integrado de Replit, que proporciona una instancia de Neon (PostgreSQL serverless). La conexión se establece mediante la variable de entorno <code>DATABASE_URL</code>.</p>

<pre>
# Variables de entorno configuradas
DATABASE_URL=postgresql://user:password@host:port/database
PGHOST=host
PGPORT=5432
PGUSER=user
PGPASSWORD=password
PGDATABASE=database
SESSION_SECRET=secret_key_for_sessions
JWT_SECRET=secret_key_for_jwt
</pre>

<h3>4.0.2. Estructura Inicial del Proyecto</h3>

<h4>4.0.2.1. Arquitectura Monorepo</h4>

<p>El proyecto se organizó siguiendo una estructura monorepo, donde el código del frontend, backend y esquemas compartidos coexisten en el mismo repositorio. Esta arquitectura facilita:</p>

<ul>
    <li>Compartir tipos y esquemas entre frontend y backend</li>
    <li>Gestión unificada de dependencias</li>
    <li>Despliegue coordinado de todos los componentes</li>
    <li>Refactorizaciones que afectan a múltiples partes del sistema</li>
</ul>

<div class="diagram">
    <pre style="background: white; color: #333; text-align: left;">
proyecto/
├── client/                 # Frontend Web (React)
│   ├── src/
│   │   ├── components/     # Componentes reutilizables
│   │   ├── pages/          # Páginas de la aplicación
│   │   ├── hooks/          # Hooks personalizados
│   │   └── lib/            # Utilidades
│   └── index.html
├── server/                 # Backend (Express)
│   ├── routes/             # Endpoints de la API
│   ├── storages/           # Capa de acceso a datos
│   ├── services/           # Lógica de negocio
│   └── index.ts            # Punto de entrada
├── shared/                 # Código compartido
│   └── schema.ts           # Esquemas de BD y validación
├── mobile-app/             # Aplicación Móvil (Expo)
│   ├── app/                # Pantallas (file-based routing)
│   ├── components/         # Componentes
│   └── services/           # Servicios de API
└── docs/                   # Documentación
    </pre>
</div>

<h2 id="fase1">4.1. Fase 1: Fase de Concepción</h2>

<h3>4.1.1. Idea Principal</h3>

<p>La idea principal del proyecto surgió de la necesidad de las empresas de cumplir con la normativa de registro horario (Real Decreto-ley 8/2019 en España), que obliga a las empresas a llevar un registro diario de la jornada de trabajo de sus empleados.</p>

<p>El sistema propuesto debía ofrecer una solución moderna que sustituyera los métodos tradicionales (hojas de firma, tarjetas de fichaje físicas) por una aplicación digital accesible y fácil de usar.</p>

<h3>4.1.2. Análisis de Requisitos</h3>

<h4>Requisitos Funcionales</h4>

<table>
    <tr>
        <th>RF</th>
        <th>Descripción</th>
        <th>Actor</th>
    </tr>
    <tr>
        <td>RF01</td>
        <td>El sistema debe permitir a los empleados registrar su entrada</td>
        <td>Empleado</td>
    </tr>
    <tr>
        <td>RF02</td>
        <td>El sistema debe permitir a los empleados registrar su salida</td>
        <td>Empleado</td>
    </tr>
    <tr>
        <td>RF03</td>
        <td>El sistema debe permitir registrar inicios y fines de pausa</td>
        <td>Empleado</td>
    </tr>
    <tr>
        <td>RF04</td>
        <td>El sistema debe capturar la ubicación GPS al fichar (opcional)</td>
        <td>Empleado</td>
    </tr>
    <tr>
        <td>RF05</td>
        <td>El administrador debe poder gestionar empleados (CRUD)</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF06</td>
        <td>El administrador debe poder gestionar departamentos</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF07</td>
        <td>El administrador debe poder gestionar roles empresariales</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF08</td>
        <td>El administrador debe poder asignar horarios a empleados</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF09</td>
        <td>El sistema debe permitir crear horarios en bloque (calendario anual)</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF10</td>
        <td>El administrador debe poder registrar incidencias</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF11</td>
        <td>El sistema debe generar informes en formato Excel</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF12</td>
        <td>El sistema debe mostrar un dashboard con estadísticas</td>
        <td>Administrador</td>
    </tr>
    <tr>
        <td>RF13</td>
        <td>El sistema debe permitir visualizar ubicaciones en mapa</td>
        <td>Administrador</td>
    </tr>
</table>

<h4>Requisitos No Funcionales</h4>

<table>
    <tr>
        <th>RNF</th>
        <th>Descripción</th>
        <th>Categoría</th>
    </tr>
    <tr>
        <td>RNF01</td>
        <td>La aplicación web debe ser responsive (móvil, tablet, desktop)</td>
        <td>Usabilidad</td>
    </tr>
    <tr>
        <td>RNF02</td>
        <td>La aplicación debe soportar modo claro y oscuro</td>
        <td>Usabilidad</td>
    </tr>
    <tr>
        <td>RNF03</td>
        <td>Los tiempos de respuesta deben ser menores a 2 segundos</td>
        <td>Rendimiento</td>
    </tr>
    <tr>
        <td>RNF04</td>
        <td>Las contraseñas deben almacenarse con hash bcrypt</td>
        <td>Seguridad</td>
    </tr>
    <tr>
        <td>RNF05</td>
        <td>Todas las fechas deben almacenarse en UTC</td>
        <td>Integridad</td>
    </tr>
    <tr>
        <td>RNF06</td>
        <td>La interfaz debe estar en español</td>
        <td>Localización</td>
    </tr>
    <tr>
        <td>RNF07</td>
        <td>El sistema debe estar disponible 24/7</td>
        <td>Disponibilidad</td>
    </tr>
</table>

<h2 id="fase2" class="page-break">4.2. Fase 2: Fase de Diseño</h2>

<h3>4.2.1. Diseño de Base de Datos</h3>

<h4>4.2.1.1. Modelo Entidad-Relación</h4>

<p>El modelo de datos se diseñó para capturar toda la información necesaria sobre empleados, sus fichajes, horarios asignados e incidencias. Las principales entidades identificadas son:</p>

<div class="diagram">
    <pre style="background: white; color: #333; text-align: left; font-size: 8pt;">
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   DEPARTMENTS   │     │      USERS      │     │  ROLES_ENTERPRISE│
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id (PK)         │◄────│ departmentId(FK)│     │ id (PK)         │
│ name            │     │ roleId (FK)     │────►│ name (UNIQUE)   │
│ description     │     │ id (PK)         │     │ description     │
└─────────────────┘     │ numEmployee(UQ) │     └─────────────────┘
                        │ firstName       │
                        │ lastName        │
                        │ email           │
                        │ password        │
                        │ isAdmin         │
                        │ isActive        │
                        └────────┬────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
          ▼                      ▼                      ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   SCHEDULES     │     │  CLOCK_ENTRIES  │     │  DAILY_WORKDAY  │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id (PK)         │     │ id (PK)         │     │ id (PK)         │
│ idUser (FK)     │     │ userId (FK)     │     │ idUser (FK)     │
│ date            │     │ entryType       │     │ date (NOT NULL) │
│ startTime       │     │ timestamp       │     │ clockIn         │
│ endTime         │     │ latitude        │     │ clockOut        │
│ startBreak      │     │ longitude       │     │ startBreak      │
│ endBreak        │     │ source          │     │ endBreak        │
│ idDailyWorkday  │     └─────────────────┘     │ totalHours      │
└─────────────────┘                             │ status          │
                                                └────────┬────────┘
                                                         │
                                                         ▼
                                                ┌─────────────────┐
                                                │    INCIDENTS    │
                                                ├─────────────────┤
                                                │ id (PK)         │
                                                │ idUser (FK)     │
                                                │ idDailyWorkday  │
                                                │ incidentTypeId  │
                                                │ registeredBy(FK)│
                                                │ description     │
                                                │ date            │
                                                └─────────────────┘
    </pre>
</div>

<h4>4.2.1.2. Esquema de Tablas</h4>

<p>A continuación se detalla el esquema de cada tabla con sus columnas, tipos de datos y restricciones:</p>

<p><strong>Tabla: users</strong></p>
<table>
    <tr><th>Columna</th><th>Tipo</th><th>Restricciones</th><th>Descripción</th></tr>
    <tr><td>id</td><td>UUID</td><td>PK, DEFAULT uuid_generate_v4()</td><td>Identificador único</td></tr>
    <tr><td>numEmployee</td><td>VARCHAR(50)</td><td>NOT NULL, UNIQUE</td><td>Número de empleado</td></tr>
    <tr><td>firstName</td><td>VARCHAR(100)</td><td>NOT NULL</td><td>Nombre</td></tr>
    <tr><td>lastName</td><td>VARCHAR(100)</td><td>NOT NULL</td><td>Apellidos</td></tr>
    <tr><td>email</td><td>VARCHAR(255)</td><td>NOT NULL, UNIQUE</td><td>Correo electrónico</td></tr>
    <tr><td>password</td><td>VARCHAR(255)</td><td>NOT NULL</td><td>Contraseña (hash bcrypt)</td></tr>
    <tr><td>departmentId</td><td>UUID</td><td>FK → departments.id</td><td>Departamento asignado</td></tr>
    <tr><td>roleId</td><td>UUID</td><td>FK → roles_enterprise.id</td><td>Rol empresarial</td></tr>
    <tr><td>isAdmin</td><td>BOOLEAN</td><td>DEFAULT false</td><td>Es administrador</td></tr>
    <tr><td>isActive</td><td>BOOLEAN</td><td>DEFAULT true</td><td>Cuenta activa</td></tr>
</table>

<p><strong>Tabla: clock_entries</strong></p>
<table>
    <tr><th>Columna</th><th>Tipo</th><th>Restricciones</th><th>Descripción</th></tr>
    <tr><td>id</td><td>UUID</td><td>PK</td><td>Identificador único</td></tr>
    <tr><td>userId</td><td>UUID</td><td>FK → users.id, NOT NULL</td><td>Empleado</td></tr>
    <tr><td>entryType</td><td>VARCHAR(20)</td><td>NOT NULL</td><td>clock_in, clock_out, break_start, break_end</td></tr>
    <tr><td>timestamp</td><td>TIMESTAMP</td><td>NOT NULL</td><td>Momento del fichaje (UTC)</td></tr>
    <tr><td>latitude</td><td>DOUBLE PRECISION</td><td>NULL</td><td>Latitud GPS</td></tr>
    <tr><td>longitude</td><td>DOUBLE PRECISION</td><td>NULL</td><td>Longitud GPS</td></tr>
    <tr><td>source</td><td>VARCHAR(20)</td><td>DEFAULT 'web'</td><td>web, mobile, manual</td></tr>
</table>

<h3>4.2.2. Diseño de Interfaz de Usuario</h3>

<h4>4.2.2.1. Componentes Shadcn/UI</h4>

<p>Para la interfaz de usuario se utilizó Shadcn/UI, una colección de componentes reutilizables construidos sobre Radix UI y estilizados con Tailwind CSS. Los principales componentes utilizados son:</p>

<ul>
    <li><strong>Button:</strong> Botones con diferentes variantes (primary, secondary, ghost, destructive)</li>
    <li><strong>Card:</strong> Contenedores para agrupar información relacionada</li>
    <li><strong>Dialog/AlertDialog:</strong> Modales para confirmaciones y formularios</li>
    <li><strong>Form:</strong> Formularios con validación integrada</li>
    <li><strong>Table:</strong> Tablas para listados de datos</li>
    <li><strong>Select/Combobox:</strong> Selectores de opciones</li>
    <li><strong>Calendar:</strong> Selector de fechas</li>
    <li><strong>Sidebar:</strong> Navegación lateral</li>
    <li><strong>Toast:</strong> Notificaciones temporales</li>
    <li><strong>Avatar:</strong> Imágenes de perfil con fallback</li>
    <li><strong>Badge:</strong> Etiquetas de estado</li>
    <li><strong>Tabs:</strong> Navegación por pestañas</li>
</ul>

<h4>4.2.2.2. Sistema de Colores y Temas</h4>

<p>El sistema de diseño utiliza variables CSS personalizadas que permiten cambiar fácilmente entre el modo claro y oscuro. Los colores principales son:</p>

<table>
    <tr>
        <th>Variable</th>
        <th>Modo Claro</th>
        <th>Modo Oscuro</th>
        <th>Uso</th>
    </tr>
    <tr>
        <td>--background</td>
        <td>hsl(210 40% 98%)</td>
        <td>hsl(222.2 84% 4.9%)</td>
        <td>Fondo principal</td>
    </tr>
    <tr>
        <td>--foreground</td>
        <td>hsl(222.2 84% 4.9%)</td>
        <td>hsl(210 40% 98%)</td>
        <td>Texto principal</td>
    </tr>
    <tr>
        <td>--primary</td>
        <td>hsl(221.2 83.2% 53.3%)</td>
        <td>hsl(210 40% 98%)</td>
        <td>Color de acento</td>
    </tr>
    <tr>
        <td>--card</td>
        <td>hsl(0 0% 100%)</td>
        <td>hsl(222.2 84% 6%)</td>
        <td>Fondo de tarjetas</td>
    </tr>
    <tr>
        <td>--destructive</td>
        <td>hsl(0 84.2% 60.2%)</td>
        <td>hsl(0 62.8% 30.6%)</td>
        <td>Acciones destructivas</td>
    </tr>
</table>

<h3>4.2.3. Diseño de API REST</h3>

<p>La API sigue los principios REST, utilizando los métodos HTTP estándar para las operaciones CRUD:</p>

<table>
    <tr>
        <th>Endpoint</th>
        <th>Método</th>
        <th>Descripción</th>
        <th>Auth</th>
    </tr>
    <tr><td>/api/auth/login</td><td>POST</td><td>Iniciar sesión</td><td>No</td></tr>
    <tr><td>/api/auth/logout</td><td>POST</td><td>Cerrar sesión</td><td>Sí</td></tr>
    <tr><td>/api/auth/me</td><td>GET</td><td>Obtener usuario actual</td><td>Sí</td></tr>
    <tr><td>/api/users</td><td>GET</td><td>Listar empleados</td><td>Admin</td></tr>
    <tr><td>/api/users</td><td>POST</td><td>Crear empleado</td><td>Admin</td></tr>
    <tr><td>/api/users/:id</td><td>GET</td><td>Obtener empleado</td><td>Admin</td></tr>
    <tr><td>/api/users/:id</td><td>PATCH</td><td>Actualizar empleado</td><td>Admin</td></tr>
    <tr><td>/api/users/:id</td><td>DELETE</td><td>Eliminar empleado</td><td>Admin</td></tr>
    <tr><td>/api/departments</td><td>GET/POST</td><td>CRUD departamentos</td><td>Admin</td></tr>
    <tr><td>/api/roles</td><td>GET/POST</td><td>CRUD roles</td><td>Admin</td></tr>
    <tr><td>/api/schedules</td><td>GET/POST</td><td>CRUD horarios</td><td>Admin</td></tr>
    <tr><td>/api/clock-entries</td><td>POST</td><td>Registrar fichaje</td><td>Empleado</td></tr>
    <tr><td>/api/clock-entries/today</td><td>GET</td><td>Fichajes de hoy</td><td>Empleado</td></tr>
    <tr><td>/api/incidents</td><td>GET/POST</td><td>CRUD incidencias</td><td>Admin</td></tr>
    <tr><td>/api/reports/excel</td><td>GET</td><td>Generar informe Excel</td><td>Admin</td></tr>
</table>

<h2 id="fase3">4.3. Fase 3: Fase de Planificación</h2>

<h3>4.3.1. División en Módulos</h3>

<p>El sistema se dividió en los siguientes módulos funcionales:</p>

<ol>
    <li><strong>Módulo de Autenticación:</strong> Login, logout, gestión de sesiones y JWT</li>
    <li><strong>Módulo de Empleados:</strong> CRUD de usuarios, gestión de perfiles</li>
    <li><strong>Módulo de Organización:</strong> Departamentos y roles empresariales</li>
    <li><strong>Módulo de Fichajes:</strong> Clock in/out, pausas, geolocalización</li>
    <li><strong>Módulo de Horarios:</strong> Planificación, calendario anual</li>
    <li><strong>Módulo de Incidencias:</strong> Registro y gestión de incidencias</li>
    <li><strong>Módulo de Informes:</strong> Dashboard, estadísticas, exportación Excel</li>
    <li><strong>Módulo de Configuración:</strong> Ajustes del sistema, tipos de incidencia</li>
</ol>

<h3>4.3.2. Priorización de Funcionalidades</h3>

<p>Utilizando el método MoSCoW, las funcionalidades se clasificaron en:</p>

<table>
    <tr>
        <th>Categoría</th>
        <th>Funcionalidades</th>
    </tr>
    <tr>
        <td><strong>Must Have</strong></td>
        <td>Autenticación, CRUD empleados, fichajes básicos, horarios</td>
    </tr>
    <tr>
        <td><strong>Should Have</strong></td>
        <td>Dashboard, informes Excel, gestión de pausas, departamentos</td>
    </tr>
    <tr>
        <td><strong>Could Have</strong></td>
        <td>Geolocalización, mapa de ubicaciones, calendario anual</td>
    </tr>
    <tr>
        <td><strong>Won't Have</strong></td>
        <td>Notificaciones push, integración con nóminas (futuro)</td>
    </tr>
</table>

<h2 id="fase4" class="page-break">4.4. Fase 4: Fase de Producción</h2>

<h3>4.4.1. Backend</h3>

<h4>4.4.1.1. Controladores (Routes)</h4>

<p>Los controladores se organizaron en archivos separados por entidad, siguiendo el principio de responsabilidad única. Cada archivo de rutas define los endpoints relacionados con una funcionalidad específica:</p>

<pre>
server/routes/
├── authRoutes.ts          # Autenticación y sesiones
├── userRoutes.ts          # Gestión de empleados
├── departmentRoutes.ts    # Departamentos
├── roleRoutes.ts          # Roles empresariales
├── scheduleRoutes.ts      # Horarios
├── clockEntryRoutes.ts    # Fichajes
├── dailyWorkdayRoutes.ts  # Jornadas diarias
├── incidentRoutes.ts      # Incidencias
├── incidentTypeRoutes.ts  # Tipos de incidencia
├── dashboardRoutes.ts     # Estadísticas
├── reportRoutes.ts        # Informes
├── timeEntriesRoutes.ts   # Entries consolidadas
└── mobileRoutes.ts        # Endpoints móviles
</pre>

<p>Ejemplo de estructura de un controlador:</p>

<pre>
// server/routes/userRoutes.ts
import { Router } from "express";
import { requireAdmin } from "../middleware/auth";
import { userStorage } from "../storages/userStorage";
import { insertUserSchema } from "@shared/schema";

const router = Router();

// GET /api/users - Listar todos los empleados
router.get("/", requireAdmin, async (req, res) => {
  try {
    const users = await userStorage.getAll();
    res.json(users);
  } catch (error) {
    res.status(500).json({ message: "Error al obtener empleados" });
  }
});

// POST /api/users - Crear nuevo empleado
router.post("/", requireAdmin, async (req, res) => {
  try {
    const validatedData = insertUserSchema.parse(req.body);
    const newUser = await userStorage.create(validatedData);
    res.status(201).json(newUser);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return res.status(400).json({ errors: error.errors });
    }
    res.status(500).json({ message: "Error al crear empleado" });
  }
});

export default router;
</pre>

<h4>4.4.1.2. Servicios</h4>

<p>La capa de servicios contiene la lógica de negocio más compleja, separada de los controladores para facilitar el testing y la reutilización:</p>

<pre>
server/services/
├── authService.ts         # Lógica de autenticación
├── dailyWorkdayService.ts # Cálculo de jornadas
├── reportService.ts       # Generación de informes
├── scheduleService.ts     # Gestión de horarios
├── clockEntryService.ts   # Procesamiento de fichajes
├── incidentService.ts     # Gestión de incidencias
├── dashboardService.ts    # Cálculo de estadísticas
├── timeEntriesService.ts  # Consolidación de datos
└── excelService.ts        # Exportación Excel
</pre>

<h4>4.4.1.3. Almacenamiento (Storages)</h4>

<p>La capa de almacenamiento encapsula todas las operaciones de base de datos, proporcionando una interfaz limpia para las operaciones CRUD:</p>

<pre>
// server/storages/userStorage.ts
import { db } from "../db";
import { users, InsertUser, User } from "@shared/schema";
import { eq } from "drizzle-orm";
import bcrypt from "bcryptjs";

export const userStorage = {
  async getAll(): Promise<User[]> {
    return db.select().from(users).where(eq(users.isActive, true));
  },

  async getById(id: string): Promise<User | undefined> {
    const [user] = await db.select().from(users).where(eq(users.id, id));
    return user;
  },

  async create(data: InsertUser): Promise<User> {
    const hashedPassword = await bcrypt.hash(data.password, 10);
    const [user] = await db
      .insert(users)
      .values({ ...data, password: hashedPassword })
      .returning();
    return user;
  },

  async update(id: string, data: Partial<InsertUser>): Promise<User> {
    if (data.password) {
      data.password = await bcrypt.hash(data.password, 10);
    }
    const [user] = await db
      .update(users)
      .set(data)
      .where(eq(users.id, id))
      .returning();
    return user;
  },

  async delete(id: string): Promise<void> {
    await db.update(users).set({ isActive: false }).where(eq(users.id, id));
  }
};
</pre>

<h4>4.4.1.4. Middleware de Autenticación</h4>

<p>Se implementaron dos sistemas de autenticación: sesiones para la web y JWT para la aplicación móvil:</p>

<pre>
// server/middleware/auth.ts
import { Request, Response, NextFunction } from "express";
import jwt from "jsonwebtoken";

// Middleware para rutas que requieren autenticación
export const requireAuth = (req: Request, res: Response, next: NextFunction) => {
  // Verificar sesión (web)
  if (req.session?.userId) {
    return next();
  }
  
  // Verificar JWT (móvil)
  const authHeader = req.headers.authorization;
  if (authHeader?.startsWith("Bearer ")) {
    const token = authHeader.substring(7);
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET!);
      req.user = decoded;
      return next();
    } catch (error) {
      // Token inválido
    }
  }
  
  res.status(401).json({ message: "No autorizado. Debe iniciar sesión." });
};

// Middleware para rutas que requieren rol de administrador
export const requireAdmin = (req: Request, res: Response, next: NextFunction) => {
  requireAuth(req, res, () => {
    if (!req.user?.isAdmin) {
      return res.status(403).json({ message: "Acceso denegado. Se requiere rol de administrador." });
    }
    next();
  });
};
</pre>

<h3>4.4.2. Frontend Web</h3>

<h4>4.4.2.1. Páginas</h4>

<p>La aplicación web consta de las siguientes páginas principales:</p>

<table>
    <tr>
        <th>Página</th>
        <th>Ruta</th>
        <th>Descripción</th>
        <th>Acceso</th>
    </tr>
    <tr><td>Login</td><td>/login</td><td>Inicio de sesión</td><td>Público</td></tr>
    <tr><td>Dashboard</td><td>/</td><td>Panel de control con estadísticas</td><td>Admin</td></tr>
    <tr><td>Fichajes</td><td>/time-tracking</td><td>Gestión de fichajes del día</td><td>Admin</td></tr>
    <tr><td>Empleados</td><td>/employees</td><td>CRUD de empleados</td><td>Admin</td></tr>
    <tr><td>Horarios</td><td>/schedules</td><td>Planificación de horarios</td><td>Admin</td></tr>
    <tr><td>Incidencias</td><td>/incidents</td><td>Gestión de incidencias</td><td>Admin</td></tr>
    <tr><td>Informes</td><td>/reports</td><td>Generación de informes</td><td>Admin</td></tr>
    <tr><td>Configuración</td><td>/settings</td><td>Departamentos, roles, tipos</td><td>Admin</td></tr>
</table>

<h4>4.4.2.2. Gestión de Estado (TanStack Query)</h4>

<p>TanStack Query (anteriormente React Query) se utilizó para gestionar el estado del servidor, proporcionando:</p>

<ul>
    <li>Caché automático de datos</li>
    <li>Revalidación en segundo plano</li>
    <li>Gestión de estados de carga y error</li>
    <li>Invalidación de caché tras mutaciones</li>
</ul>

<pre>
// Ejemplo de uso de TanStack Query
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";

// Query para obtener empleados
const { data: employees, isLoading } = useQuery({
  queryKey: ["/api/users"],
});

// Mutation para crear empleado
const queryClient = useQueryClient();
const createMutation = useMutation({
  mutationFn: (data: InsertUser) => apiRequest("/api/users", "POST", data),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ["/api/users"] });
    toast({ title: "Empleado creado correctamente" });
  },
});
</pre>

<h3>4.4.3. Aplicación Móvil</h3>

<h4>4.4.3.1. Navegación (Expo Router)</h4>

<p>La aplicación móvil utiliza Expo Router con navegación basada en archivos:</p>

<pre>
mobile-app/app/
├── _layout.tsx          # Layout raíz
├── index.tsx            # Redirección inicial
├── login.tsx            # Pantalla de login
└── (tabs)/              # Grupo de pestañas (autenticado)
    ├── _layout.tsx      # Layout de pestañas
    ├── index.tsx        # Dashboard / Fichar
    ├── schedules.tsx    # Mis horarios
    ├── history.tsx      # Historial de fichajes
    └── profile.tsx      # Mi perfil
</pre>

<h4>4.4.3.2. Geolocalización</h4>

<p>La captura de ubicación se implementó utilizando Expo Location:</p>

<pre>
import * as Location from 'expo-location';

const getLocation = async () => {
  const { status } = await Location.requestForegroundPermissionsAsync();
  if (status !== 'granted') {
    return null;
  }
  
  const location = await Location.getCurrentPositionAsync({
    accuracy: Location.Accuracy.High,
  });
  
  return {
    latitude: location.coords.latitude,
    longitude: location.coords.longitude,
  };
};
</pre>

<h3>4.4.4. Implementación de Funcionalidades Destacadas</h3>

<h4>4.4.4.1. Sistema de Fichaje</h4>

<p>El sistema de fichaje permite registrar cuatro tipos de eventos:</p>

<ul>
    <li><strong>clock_in:</strong> Entrada al trabajo</li>
    <li><strong>clock_out:</strong> Salida del trabajo</li>
    <li><strong>break_start:</strong> Inicio de pausa</li>
    <li><strong>break_end:</strong> Fin de pausa</li>
</ul>

<p>Cada fichaje se registra con timestamp en UTC y opcionalmente con coordenadas GPS.</p>

<h4>4.4.4.2. Calendario Anual de Horarios</h4>

<p>El calendario permite visualizar y gestionar los horarios de todo un año, con diferenciación visual por tipo de turno:</p>

<ul>
    <li><strong>Verde:</strong> Turnos continuos (sin pausa)</li>
    <li><strong>Naranja:</strong> Turnos partidos (con pausa)</li>
</ul>

<h4>4.4.4.3. Generación de Informes Excel</h4>

<p>Los informes se generan utilizando la biblioteca ExcelJS, creando un libro con:</p>

<ul>
    <li>Una hoja por cada empleado</li>
    <li>Desglose diario de horarios asignados vs. horas reales</li>
    <li>Cálculo de pausas y horas extraordinarias</li>
    <li>Registro de incidencias</li>
</ul>

<h2 id="fase5" class="page-break">4.5. Fase 5: Fase de Pruebas</h2>

<h3>4.5.1. Pruebas Funcionales</h3>

<p>Se realizaron pruebas funcionales manuales para verificar el correcto funcionamiento de todas las características:</p>

<table>
    <tr>
        <th>Caso de Prueba</th>
        <th>Descripción</th>
        <th>Resultado</th>
    </tr>
    <tr><td>CP-01</td><td>Login con credenciales válidas</td><td>✓ Correcto</td></tr>
    <tr><td>CP-02</td><td>Login con credenciales inválidas</td><td>✓ Error mostrado</td></tr>
    <tr><td>CP-03</td><td>Crear nuevo empleado</td><td>✓ Correcto</td></tr>
    <tr><td>CP-04</td><td>Editar empleado existente</td><td>✓ Correcto</td></tr>
    <tr><td>CP-05</td><td>Eliminar empleado (soft delete)</td><td>✓ Correcto</td></tr>
    <tr><td>CP-06</td><td>Registrar entrada (clock in)</td><td>✓ Correcto</td></tr>
    <tr><td>CP-07</td><td>Registrar salida (clock out)</td><td>✓ Correcto</td></tr>
    <tr><td>CP-08</td><td>Registrar pausa inicio/fin</td><td>✓ Correcto</td></tr>
    <tr><td>CP-09</td><td>Asignar horario a empleado</td><td>✓ Correcto</td></tr>
    <tr><td>CP-10</td><td>Crear horarios en bloque</td><td>✓ Correcto</td></tr>
    <tr><td>CP-11</td><td>Registrar incidencia</td><td>✓ Correcto</td></tr>
    <tr><td>CP-12</td><td>Generar informe Excel</td><td>✓ Correcto</td></tr>
    <tr><td>CP-13</td><td>Visualizar dashboard</td><td>✓ Correcto</td></tr>
    <tr><td>CP-14</td><td>Cambiar tema claro/oscuro</td><td>✓ Correcto</td></tr>
    <tr><td>CP-15</td><td>Fichaje móvil con geolocalización</td><td>✓ Correcto</td></tr>
</table>

<h3>4.5.2. Pruebas de Integración</h3>

<p>Se verificó la correcta integración entre los diferentes componentes del sistema:</p>

<ul>
    <li>Frontend Web ↔ Backend API</li>
    <li>App Móvil ↔ Backend API</li>
    <li>Backend ↔ Base de datos PostgreSQL</li>
    <li>Autenticación JWT (móvil) y Sesiones (web)</li>
</ul>

<h2 id="fase6">4.6. Fase 6: Fase de Despliegue</h2>

<h3>4.6.1. Publicación Web (Replit Deployments)</h3>

<p>La aplicación web se despliega directamente desde Replit utilizando su sistema de Deployments, que proporciona:</p>

<ul>
    <li>Dominio automático (.replit.app)</li>
    <li>HTTPS automático</li>
    <li>Escalado automático</li>
    <li>Health checks</li>
</ul>

<h3>4.6.2. Compilación APK (EAS Build)</h3>

<p>La aplicación móvil se compila utilizando Expo Application Services (EAS):</p>

<pre>
# Configurar EAS
eas build:configure

# Compilar APK para Android
eas build --platform android --profile production

# El APK resultante puede distribuirse directamente o publicarse en Google Play
</pre>

<!-- CAPÍTULO 5: ARQUITECTURA -->
<h1 id="arquitectura" class="page-break">5. ARQUITECTURA DE LA APLICACIÓN</h1>

<h2 id="arq-general">5.1. Arquitectura General</h2>

<h3>5.1.1. Diagrama de Arquitectura</h3>

<div class="diagram">
    <pre style="background: white; color: #333; text-align: left;">
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENTES                                 │
├─────────────────────────────┬───────────────────────────────────┤
│      APLICACIÓN WEB         │       APLICACIÓN MÓVIL            │
│    (React + TypeScript)     │   (React Native + Expo)           │
│         [Puerto 5000]       │         [APK/iOS]                 │
└──────────────┬──────────────┴──────────────┬────────────────────┘
               │                              │
               │  HTTP/HTTPS                  │  HTTP/HTTPS
               │  (Sesiones)                  │  (JWT)
               ▼                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       SERVIDOR                                   │
│                  (Node.js + Express)                             │
│                     [Puerto 5000]                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   ROUTES    │  │  SERVICES   │  │       STORAGES          │  │
│  │ (Controllers)│  │(Biz Logic)  │  │   (Data Access)         │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
│         │                │                      │                │
│         └────────────────┴──────────────────────┘                │
│                          │                                       │
│                    Drizzle ORM                                   │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │      BASE DE DATOS     │
              │  PostgreSQL (Neon)     │
              └────────────────────────┘
    </pre>
</div>

<h3>5.1.2. Flujo de Datos</h3>

<p>El flujo de datos en la aplicación sigue el patrón request-response típico de las aplicaciones web:</p>

<ol>
    <li><strong>Cliente:</strong> El usuario interactúa con la interfaz (web o móvil)</li>
    <li><strong>Petición HTTP:</strong> La aplicación envía una petición al servidor</li>
    <li><strong>Middleware:</strong> Se verifica autenticación y permisos</li>
    <li><strong>Controlador:</strong> Se procesa la petición y se validan los datos</li>
    <li><strong>Servicio:</strong> Se ejecuta la lógica de negocio necesaria</li>
    <li><strong>Storage:</strong> Se accede a la base de datos mediante Drizzle ORM</li>
    <li><strong>Respuesta:</strong> Los datos se devuelven al cliente en formato JSON</li>
    <li><strong>Actualización UI:</strong> TanStack Query actualiza la caché y la interfaz</li>
</ol>

<h2 id="arq-backend">5.2. Arquitectura del Backend</h2>

<h3>5.2.1. Patrón MVC Adaptado</h3>

<p>El backend sigue una variante del patrón MVC (Model-View-Controller), adaptada para APIs REST:</p>

<ul>
    <li><strong>Model:</strong> Definido en <code>shared/schema.ts</code> mediante Drizzle ORM</li>
    <li><strong>Controller:</strong> Los archivos en <code>server/routes/</code> actúan como controladores</li>
    <li><strong>Service:</strong> Capa adicional en <code>server/services/</code> para lógica compleja</li>
    <li><strong>Storage:</strong> Capa de abstracción en <code>server/storages/</code> para acceso a datos</li>
</ul>

<h3>5.2.2. Capas de la Aplicación</h3>

<div class="diagram">
    <pre style="background: white; color: #333; text-align: left;">
┌────────────────────────────────────────────────┐
│              CAPA DE PRESENTACIÓN               │
│  (Routes - Validación - Serialización)          │
├────────────────────────────────────────────────┤
│              CAPA DE SERVICIOS                  │
│  (Lógica de Negocio - Cálculos - Reglas)       │
├────────────────────────────────────────────────┤
│              CAPA DE DATOS                      │
│  (Storages - Queries - Transacciones)          │
├────────────────────────────────────────────────┤
│              CAPA DE PERSISTENCIA               │
│  (Drizzle ORM - PostgreSQL)                     │
└────────────────────────────────────────────────┘
    </pre>
</div>

<h2 id="arq-frontend">5.3. Arquitectura del Frontend</h2>

<h3>5.3.1. Estructura de Componentes</h3>

<p>Los componentes se organizan siguiendo el principio de composición de React:</p>

<ul>
    <li><strong>Páginas (pages/):</strong> Componentes de nivel superior que representan rutas</li>
    <li><strong>Componentes UI (components/ui/):</strong> Componentes base reutilizables (Shadcn)</li>
    <li><strong>Componentes de dominio (components/):</strong> Componentes específicos de la aplicación</li>
    <li><strong>Hooks (hooks/):</strong> Lógica reutilizable extraída en hooks personalizados</li>
    <li><strong>Utilidades (lib/):</strong> Funciones auxiliares y configuraciones</li>
</ul>

<!-- CAPÍTULO 6: ESTRUCTURA VISUAL -->
<h1 id="visual" class="page-break">6. ESTRUCTURA VISUAL DE LA APLICACIÓN</h1>

<h2 id="visual-web">6.1. Aplicación Web</h2>

<h3>6.1.1. Sidebar de Navegación</h3>

<p>La aplicación web utiliza un sidebar lateral como principal elemento de navegación. El sidebar incluye:</p>

<ul>
    <li>Logo y nombre de la aplicación</li>
    <li>Enlaces a las secciones principales</li>
    <li>Indicador visual de la sección activa</li>
    <li>Botón para contraer/expandir</li>
    <li>Información del usuario y botón de logout</li>
</ul>

<h3>6.1.2. Páginas Principales</h3>

<p><strong>Dashboard:</strong> Muestra tarjetas con estadísticas clave como total de empleados, empleados presentes, ausentes, y gráficos de tendencias.</p>

<p><strong>Control de Fichajes:</strong> Lista de empleados con su estado actual (trabajando, en pausa, ausente), con posibilidad de ver detalles y ubicación en mapa.</p>

<p><strong>Gestión de Empleados:</strong> Tabla con todos los empleados, filtros por departamento y rol, y formularios para crear/editar.</p>

<p><strong>Planificación de Horarios:</strong> Calendario anual interactivo con vista por empleado, permitiendo asignar turnos individuales o en bloque.</p>

<h2 id="visual-mobile">6.2. Aplicación Móvil</h2>

<h3>6.2.1. Navegación por Tabs</h3>

<p>La aplicación móvil utiliza una barra de navegación inferior con cuatro secciones:</p>

<ul>
    <li><strong>Fichar:</strong> Pantalla principal con botones para entrada, salida y pausas</li>
    <li><strong>Horarios:</strong> Visualización de los horarios asignados al empleado</li>
    <li><strong>Historial:</strong> Registro de fichajes anteriores</li>
    <li><strong>Perfil:</strong> Información del usuario y opciones de cuenta</li>
</ul>

<h3>6.2.2. Pantalla de Fichaje</h3>

<p>La pantalla principal muestra:</p>

<ul>
    <li>Estado actual del empleado (No fichado / Trabajando / En pausa)</li>
    <li>Hora del último fichaje</li>
    <li>Botones contextuales según el estado (Entrada si no ha fichado, Salida/Pausa si está trabajando)</li>
    <li>Resumen de la jornada actual</li>
</ul>

<!-- CAPÍTULO 7: GESTIÓN DE DATOS -->
<h1 id="datos" class="page-break">7. GESTIÓN DE DATOS</h1>

<h2 id="modelo">7.1. Modelo de Datos</h2>

<p>El modelo de datos del sistema está compuesto por 8 tablas principales que almacenan toda la información necesaria para la gestión del fichaje de empleados.</p>

<h3>7.1.1. Tabla USERS</h3>
<p>Almacena la información de todos los usuarios del sistema, tanto empleados como administradores.</p>

<h3>7.1.2. Tabla DEPARTMENTS</h3>
<p>Contiene los departamentos de la organización a los que se asignan los empleados.</p>

<h3>7.1.3. Tabla ROLES_ENTERPRISE</h3>
<p>Define los roles empresariales (puestos de trabajo) que pueden asignarse a los empleados.</p>

<h3>7.1.4. Tabla SCHEDULES</h3>
<p>Almacena los horarios planificados para cada empleado y fecha.</p>

<h3>7.1.5. Tabla CLOCK_ENTRIES</h3>
<p>Registra cada evento de fichaje individual con su timestamp y ubicación opcional.</p>

<h3>7.1.6. Tabla DAILY_WORKDAY</h3>
<p>Consolida la jornada diaria de cada empleado, calculando horas totales trabajadas.</p>

<h3>7.1.7. Tabla INCIDENTS</h3>
<p>Registra las incidencias laborales asociadas a empleados y jornadas.</p>

<h3>7.1.8. Tabla INCIDENTS_TYPE</h3>
<p>Define los tipos de incidencias disponibles en el sistema.</p>

<h2 id="timezone">7.2. Gestión de Zonas Horarias</h2>

<h3>7.2.1. Almacenamiento en UTC</h3>

<p>Todas las fechas y horas se almacenan en la base de datos en formato UTC (Coordinated Universal Time). Esta decisión de diseño proporciona:</p>

<ul>
    <li><strong>Consistencia:</strong> Todos los timestamps tienen el mismo punto de referencia</li>
    <li><strong>Comparabilidad:</strong> Las comparaciones de fechas son directas sin conversiones</li>
    <li><strong>Internacionalización:</strong> Facilita el soporte de múltiples zonas horarias en el futuro</li>
</ul>

<h3>7.2.2. Conversión a Hora Española</h3>

<p>Para la visualización, todas las fechas se convierten a la zona horaria de España (Europe/Madrid):</p>

<pre>
import { toZonedTime, format } from 'date-fns-tz';

const formatSpanishTime = (utcDate: Date): string => {
  const spanishDate = toZonedTime(utcDate, 'Europe/Madrid');
  return format(spanishDate, 'HH:mm', { timeZone: 'Europe/Madrid' });
};

// Para filtrar por fecha en queries SQL
// DATE(timestamp AT TIME ZONE 'Europe/Madrid') = '2025-11-02'
</pre>

<div class="highlight">
    <strong>Importante:</strong> Las consultas SQL que filtran por fecha deben aplicar la conversión de zona horaria para evitar que un fichaje a las 23:30 hora española (que en UTC sería 22:30 o 21:30 según horario de verano/invierno) aparezca en el día incorrecto.
</div>

<!-- CAPÍTULO 8: SEGURIDAD -->
<h1 id="seguridad" class="page-break">8. SEGURIDAD</h1>

<h2 id="auth">8.1. Autenticación</h2>

<h3>8.1.1. Sesiones (Web)</h3>

<p>La aplicación web utiliza sesiones del lado del servidor mediante <code>express-session</code>:</p>

<ul>
    <li>Las sesiones se almacenan en memoria (en producción se recomienda Redis)</li>
    <li>El ID de sesión se envía en una cookie HTTP-only</li>
    <li>La cookie tiene configuración <code>sameSite: 'lax'</code> para prevenir CSRF</li>
    <li>Las sesiones expiran tras un período de inactividad configurable</li>
</ul>

<h3>8.1.2. JWT (Móvil)</h3>

<p>La aplicación móvil utiliza JSON Web Tokens para la autenticación:</p>

<ul>
    <li>El token se genera en el login y se almacena de forma segura en el dispositivo</li>
    <li>Cada petición incluye el token en el header <code>Authorization: Bearer &lt;token&gt;</code></li>
    <li>Los tokens tienen una expiración configurable (por defecto 7 días)</li>
    <li>El token contiene el ID del usuario y su rol (isAdmin)</li>
</ul>

<h2 id="authz">8.2. Autorización</h2>

<h3>8.2.1. Roles de Usuario</h3>

<p>El sistema define dos roles principales:</p>

<table>
    <tr>
        <th>Rol</th>
        <th>Permisos</th>
    </tr>
    <tr>
        <td><strong>Empleado</strong></td>
        <td>Ver y modificar sus propios fichajes, ver sus horarios, ver su historial</td>
    </tr>
    <tr>
        <td><strong>Administrador</strong></td>
        <td>Acceso completo: gestión de empleados, departamentos, horarios, incidencias, informes</td>
    </tr>
</table>

<h3>8.2.2. Encriptación de Contraseñas</h3>

<p>Las contraseñas se almacenan utilizando bcrypt con un factor de coste de 10 rondas:</p>

<pre>
import bcrypt from 'bcryptjs';

// Al crear/actualizar contraseña
const hashedPassword = await bcrypt.hash(plainPassword, 10);

// Al verificar en login
const isValid = await bcrypt.compare(inputPassword, storedHash);
</pre>

<!-- CAPÍTULO 9: TESTS -->
<h1 id="tests" class="page-break">9. TESTS Y VALIDACIÓN</h1>

<h2>9.1. Estrategia de Testing</h2>

<p>Se implementó una estrategia de testing manual exhaustiva, verificando cada funcionalidad del sistema en diferentes escenarios:</p>

<h3>9.1.1. Tests de Autenticación</h3>
<ul>
    <li>Login con credenciales correctas</li>
    <li>Login con credenciales incorrectas</li>
    <li>Acceso a rutas protegidas sin autenticación</li>
    <li>Logout y expiración de sesión</li>
</ul>

<h3>9.1.2. Tests de CRUD</h3>
<ul>
    <li>Creación de entidades con datos válidos</li>
    <li>Creación con datos inválidos (validación)</li>
    <li>Edición parcial de entidades</li>
    <li>Eliminación y verificación de soft delete</li>
    <li>Eliminación en cascada (empleado con fichajes)</li>
</ul>

<h3>9.1.3. Tests de Fichajes</h3>
<ul>
    <li>Registro de entrada sin fichaje previo</li>
    <li>Registro de salida tras entrada</li>
    <li>Pausas múltiples en una jornada</li>
    <li>Cálculo correcto de horas trabajadas</li>
    <li>Fichaje con geolocalización</li>
</ul>

<h3>9.1.4. Tests de Informes</h3>
<ul>
    <li>Generación de Excel con datos correctos</li>
    <li>Formato de fechas y horas en zona española</li>
    <li>Cálculo de diferencias horarias</li>
</ul>

<!-- CAPÍTULO 10: ANÁLISIS Y VALORACIÓN -->
<h1 id="analisis" class="page-break">10. ANÁLISIS Y VALORACIÓN</h1>

<h2 id="conclusiones">10.1. Conclusiones</h2>

<p>El desarrollo del Sistema de Control de Fichajes de Empleados ha sido un proyecto completo que ha permitido aplicar conocimientos de desarrollo full-stack moderno, desde el diseño de bases de datos hasta la implementación de interfaces de usuario responsivas.</p>

<h3>10.1.1. Objetivos Cumplidos</h3>

<table>
    <tr>
        <th>Objetivo</th>
        <th>Estado</th>
        <th>Observaciones</th>
    </tr>
    <tr>
        <td>Sistema de autenticación seguro</td>
        <td>✓ Completado</td>
        <td>Sesiones web + JWT móvil</td>
    </tr>
    <tr>
        <td>Fichaje con registro temporal</td>
        <td>✓ Completado</td>
        <td>Incluye pausas y geolocalización</td>
    </tr>
    <tr>
        <td>Gestión completa de empleados</td>
        <td>✓ Completado</td>
        <td>CRUD con soft delete</td>
    </tr>
    <tr>
        <td>Planificación de horarios</td>
        <td>✓ Completado</td>
        <td>Calendario anual implementado</td>
    </tr>
    <tr>
        <td>Generación de informes Excel</td>
        <td>✓ Completado</td>
        <td>Desglose por empleado y día</td>
    </tr>
    <tr>
        <td>Aplicación móvil nativa</td>
        <td>✓ Completado</td>
        <td>APK generado con Expo</td>
    </tr>
    <tr>
        <td>Interfaz responsive</td>
        <td>✓ Completado</td>
        <td>Funcional en todos los dispositivos</td>
    </tr>
    <tr>
        <td>Modo claro/oscuro</td>
        <td>✓ Completado</td>
        <td>Preferencia guardada</td>
    </tr>
</table>

<h3>10.1.2. Lecciones Aprendidas</h3>

<ul>
    <li><strong>Gestión de zonas horarias:</strong> Es fundamental decidir desde el inicio cómo se manejarán las fechas y horas. El almacenamiento en UTC con conversión a la zona local ha demostrado ser la mejor práctica.</li>
    <li><strong>Tipado estático:</strong> TypeScript ha sido invaluable para detectar errores en tiempo de desarrollo y facilitar las refactorizaciones.</li>
    <li><strong>Arquitectura modular:</strong> La separación en capas (routes, services, storages) facilita enormemente el mantenimiento y las pruebas.</li>
    <li><strong>Componentes reutilizables:</strong> Shadcn/UI acelera significativamente el desarrollo de interfaces consistentes.</li>
</ul>

<h2 id="mejoras">10.2. Mejoras Propuestas</h2>

<p>Para futuras versiones del sistema se proponen las siguientes mejoras:</p>

<h3>Mejoras Funcionales</h3>
<ul>
    <li><strong>Notificaciones push:</strong> Alertas en móvil para recordar fichajes</li>
    <li><strong>Aprobación de fichajes:</strong> Flujo de supervisión para fichajes manuales</li>
    <li><strong>Integración con nóminas:</strong> Exportación de datos a sistemas de gestión de nóminas</li>
    <li><strong>Reconocimiento facial:</strong> Verificación biométrica al fichar</li>
    <li><strong>Fichaje por QR:</strong> Alternativa a la geolocalización para ubicaciones fijas</li>
</ul>

<h3>Mejoras Técnicas</h3>
<ul>
    <li><strong>Tests automatizados:</strong> Implementar suite de tests unitarios y de integración</li>
    <li><strong>Caché Redis:</strong> Mejorar rendimiento con caché distribuida</li>
    <li><strong>WebSockets:</strong> Actualizaciones en tiempo real del dashboard</li>
    <li><strong>PWA:</strong> Convertir la web en Progressive Web App</li>
    <li><strong>Logs estructurados:</strong> Sistema de logging para debugging en producción</li>
</ul>

<!-- CAPÍTULO 11: BIBLIOGRAFÍA -->
<h1 id="biblio" class="page-break">11. BIBLIOGRAFÍA Y REFERENCIAS</h1>

<h2>11.1. Documentación Oficial</h2>

<ul>
    <li><strong>React:</strong> <a href="https://react.dev">https://react.dev</a></li>
    <li><strong>TypeScript:</strong> <a href="https://www.typescriptlang.org/docs/">https://www.typescriptlang.org/docs/</a></li>
    <li><strong>Expo:</strong> <a href="https://docs.expo.dev">https://docs.expo.dev</a></li>
    <li><strong>Drizzle ORM:</strong> <a href="https://orm.drizzle.team">https://orm.drizzle.team</a></li>
    <li><strong>TanStack Query:</strong> <a href="https://tanstack.com/query/latest">https://tanstack.com/query/latest</a></li>
    <li><strong>Shadcn/UI:</strong> <a href="https://ui.shadcn.com">https://ui.shadcn.com</a></li>
    <li><strong>Tailwind CSS:</strong> <a href="https://tailwindcss.com/docs">https://tailwindcss.com/docs</a></li>
    <li><strong>Express:</strong> <a href="https://expressjs.com">https://expressjs.com</a></li>
    <li><strong>PostgreSQL:</strong> <a href="https://www.postgresql.org/docs/">https://www.postgresql.org/docs/</a></li>
    <li><strong>date-fns:</strong> <a href="https://date-fns.org">https://date-fns.org</a></li>
    <li><strong>Zod:</strong> <a href="https://zod.dev">https://zod.dev</a></li>
</ul>

<h2>11.2. Recursos Web</h2>

<ul>
    <li>MDN Web Docs - JavaScript Reference</li>
    <li>Stack Overflow - Resolución de problemas específicos</li>
    <li>GitHub - Repositorios de ejemplo y librerías</li>
    <li>Dev.to y Medium - Artículos técnicos</li>
</ul>

<h2>11.3. Normativa Legal</h2>

<ul>
    <li>Real Decreto-ley 8/2019 - Registro de jornada laboral</li>
    <li>RGPD - Protección de datos personales</li>
</ul>

<!-- CAPÍTULO 12: ANEXOS -->
<h1 id="anexos" class="page-break">12. ANEXOS</h1>

<h2>12.1. Estructura de Carpetas del Proyecto</h2>

<pre>
proyecto/
├── client/                         # Frontend Web
│   ├── src/
│   │   ├── components/
│   │   │   ├── ui/                 # Componentes Shadcn
│   │   │   ├── app-sidebar.tsx     # Sidebar principal
│   │   │   └── theme-toggle.tsx    # Toggle tema
│   │   ├── pages/
│   │   │   ├── dashboard.tsx       # Panel de control
│   │   │   ├── employees.tsx       # Gestión empleados
│   │   │   ├── time-tracking.tsx   # Control fichajes
│   │   │   ├── schedules.tsx       # Horarios
│   │   │   ├── incidents.tsx       # Incidencias
│   │   │   ├── reports.tsx         # Informes
│   │   │   ├── settings.tsx        # Configuración
│   │   │   └── login.tsx           # Inicio sesión
│   │   ├── hooks/
│   │   │   └── use-toast.ts        # Hook notificaciones
│   │   ├── lib/
│   │   │   ├── queryClient.ts      # Configuración TanStack
│   │   │   └── utils.ts            # Utilidades
│   │   ├── App.tsx                 # Componente raíz
│   │   ├── index.css               # Estilos globales
│   │   └── main.tsx                # Punto de entrada
│   └── index.html
│
├── server/                         # Backend
│   ├── routes/                     # Controladores
│   │   ├── authRoutes.ts
│   │   ├── userRoutes.ts
│   │   ├── departmentRoutes.ts
│   │   ├── roleRoutes.ts
│   │   ├── scheduleRoutes.ts
│   │   ├── clockEntryRoutes.ts
│   │   ├── dailyWorkdayRoutes.ts
│   │   ├── incidentRoutes.ts
│   │   ├── incidentTypeRoutes.ts
│   │   ├── dashboardRoutes.ts
│   │   ├── reportRoutes.ts
│   │   └── index.ts
│   ├── storages/                   # Acceso a datos
│   │   ├── userStorage.ts
│   │   ├── departmentStorage.ts
│   │   ├── roleStorage.ts
│   │   ├── scheduleStorage.ts
│   │   ├── clockEntryStorage.ts
│   │   ├── dailyWorkdayStorage.ts
│   │   ├── incidentStorage.ts
│   │   └── incidentTypeStorage.ts
│   ├── services/                   # Lógica de negocio
│   │   ├── authService.ts
│   │   ├── dailyWorkdayService.ts
│   │   ├── reportService.ts
│   │   └── excelService.ts
│   ├── middleware/
│   │   └── auth.ts                 # Autenticación
│   ├── utils/
│   │   └── timezone.ts             # Utilidades fecha/hora
│   ├── db.ts                       # Conexión BD
│   └── index.ts                    # Punto de entrada
│
├── shared/                         # Código compartido
│   └── schema.ts                   # Esquemas Drizzle + Zod
│
├── mobile-app/                     # Aplicación Móvil
│   ├── app/
│   │   ├── _layout.tsx
│   │   ├── login.tsx
│   │   └── (tabs)/
│   │       ├── _layout.tsx
│   │       ├── index.tsx           # Fichar
│   │       ├── schedules.tsx       # Horarios
│   │       ├── history.tsx         # Historial
│   │       └── profile.tsx         # Perfil
│   ├── components/
│   ├── services/
│   │   └── api.ts                  # Cliente API
│   ├── types/
│   │   └── schema.ts               # Tipos TypeScript
│   └── app.json                    # Configuración Expo
│
├── docs/                           # Documentación
├── drizzle.config.ts               # Config migraciones
├── package.json
├── tsconfig.json
└── vite.config.ts
</pre>

<h2>12.2. Variables de Entorno</h2>

<table>
    <tr>
        <th>Variable</th>
        <th>Descripción</th>
        <th>Ejemplo</th>
    </tr>
    <tr>
        <td>DATABASE_URL</td>
        <td>URL de conexión PostgreSQL</td>
        <td>postgresql://user:pass@host:5432/db</td>
    </tr>
    <tr>
        <td>SESSION_SECRET</td>
        <td>Secreto para firmar sesiones</td>
        <td>random-string-32-chars</td>
    </tr>
    <tr>
        <td>JWT_SECRET</td>
        <td>Secreto para firmar tokens JWT</td>
        <td>another-random-string</td>
    </tr>
    <tr>
        <td>NODE_ENV</td>
        <td>Entorno de ejecución</td>
        <td>development | production</td>
    </tr>
</table>

<h2>12.3. Guía Rápida de Instalación</h2>

<ol>
    <li>Clonar el repositorio o abrir en Replit</li>
    <li>Configurar las variables de entorno</li>
    <li>Crear la base de datos PostgreSQL</li>
    <li>Ejecutar <code>npm install</code></li>
    <li>Ejecutar migraciones con <code>npm run db:push</code></li>
    <li>Iniciar con <code>npm run dev</code></li>
    <li>Acceder a <code>http://localhost:5000</code></li>
</ol>

<h2>12.4. Compilación de la Aplicación Móvil</h2>

<ol>
    <li>Navegar a <code>mobile-app/</code></li>
    <li>Actualizar la URL del servidor en <code>services/api.ts</code></li>
    <li>Ejecutar <code>npx eas build --platform android --profile production</code></li>
    <li>Descargar el APK generado desde Expo</li>
</ol>

<div class="page-break"></div>

<div style="text-align: center; margin-top: 100px;">
    <h2>FIN DEL DOCUMENTO</h2>
    <p style="color: #64748b; margin-top: 40px;">
        Sistema de Control de Fichajes de Empleados<br>
        Memoria del Proyecto<br>
        Noviembre 2025
    </p>
</div>

</body>
</html>
